#!/usr/bin/env sh
set -eu

# -------------------------------------------------------------------
# PURPOSE:
#   Apply enabled kits based on user configuration
#
# SCOPE:
#   - Runs on: macOS only (excluded on Linux via .chezmoiignore)
#   - Lifecycle: run_onchange (re-runs when config changes)
#
# BEHAVIOUR:
#   - Loops through enabled kits in .kits configuration
#   - Applies Brewfile for each kit (primary mechanism)
#   - Runs optional setup.sh for custom configuration
#   - Kits are co-located in ~/.config/kits/
#
# NOTES:
#   - Brewfile changes trigger re-run automatically
#   - setup.sh is optional (only for outliers beyond packages)
#   - This is an orchestrator only - kits manage their own logic
# -------------------------------------------------------------------

# shellcheck source=../../_lib/log.sh
. "{{ .chezmoi.sourceDir }}/_lib/log.sh"
# shellcheck source=../../_lib/brew.sh
. "{{ .chezmoi.sourceDir }}/_lib/brew.sh"

SCRIPT_NAME="30-kits/30-apply-kits.sh"

{{- if ne .chezmoi.os "darwin" }}
log_script_skip "$SCRIPT_NAME" "not macOS"
exit 0
{{- end }}

log_script_start "$SCRIPT_NAME"

KITS_DIR="{{ .chezmoi.homeDir }}/.config/kits"

# Check if kits directory exists
if [ ! -d "$KITS_DIR" ]; then
  log_warn "Kits directory not found: $KITS_DIR"
  log_script_end "$SCRIPT_NAME"
  exit 0
fi

# Track if any kits were applied
APPLIED_COUNT=0

# Loop through enabled kits dynamically from config
{{- range $kit, $enabled := .kits }}
{{- if $enabled }}

# Kit: {{ $kit }}
KIT_NAME="{{ $kit }}"
KIT_DIR="$KITS_DIR/$KIT_NAME"
BREWFILE="$KIT_DIR/Brewfile"
SETUP_SCRIPT="$KIT_DIR/setup.sh"

if [ ! -d "$KIT_DIR" ]; then
  log_warn "Kit directory not found: $KIT_DIR (skipping)"
else
  log_info "Processing kit: $KIT_NAME"
  
  # Apply Brewfile (primary mechanism)
  if [ -f "$BREWFILE" ]; then
    if apply_brewfile "$BREWFILE"; then
      APPLIED_COUNT=$((APPLIED_COUNT + 1))
    else
      log_error "Kit Brewfile failed: $KIT_NAME"
      log_script_end "$SCRIPT_NAME"
      exit 1
    fi
  else
    log_warn "No Brewfile found for kit: $KIT_NAME"
  fi
  
  # Run optional setup script (outliers only)
  if [ -f "$SETUP_SCRIPT" ]; then
    log_info "Running setup script: $KIT_NAME"
    
    if sh "$SETUP_SCRIPT"; then
      log_success "Setup complete: $KIT_NAME"
    else
      log_error "Setup failed: $KIT_NAME"
      log_script_end "$SCRIPT_NAME"
      exit 1
    fi
  fi
fi

{{- end }}
{{- end }}

# Summary
if [ "$APPLIED_COUNT" -eq 0 ]; then
  log_info "No kits enabled or applied"
else
  log_success "Applied $APPLIED_COUNT kit(s)"
fi

log_script_end "$SCRIPT_NAME"
