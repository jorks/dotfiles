#!/usr/bin/env sh
set -eu

# -------------------------------------------------------------------
# PURPOSE:
#   Install Homebrew package manager on macOS
#
# SCOPE:
#   - Runs on: macOS only (excluded on Linux via .chezmoiignore)
#   - Lifecycle: run_once
#
# BEHAVIOUR:
#   - Idempotent (skips if already installed)
#   - Uses official Homebrew install script
#   - Non-interactive installation
#
# NOTES:
#   - Required for all subsequent package installations on macOS
#   - Installs to /opt/homebrew (Apple Silicon) or /usr/local (Intel)
# -------------------------------------------------------------------

# shellcheck source=../../_lib/log.sh
. "{{ .chezmoi.sourceDir }}/_lib/log.sh"

SCRIPT_NAME="00-base/05-macos-homebrew.sh"
log_script_start "$SCRIPT_NAME"

# Check if Homebrew already installed
if command -v brew >/dev/null 2>&1; then
  log_info "Homebrew already installed at: $(command -v brew)"
  log_script_end "$SCRIPT_NAME"
  exit 0
fi

log_info "Installing Homebrew..."

INSTALL_CMD='/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'

run_homebrew_install() {
  sh -c "$INSTALL_CMD"
}

run_homebrew_install_noninteractive() {
  NONINTERACTIVE=1 sh -c "$INSTALL_CMD"
}

if [ -n "${CI:-}" ]; then
  log_info "CI detected: running Homebrew install non-interactively"
  run_homebrew_install_noninteractive

elif sudo -n true >/dev/null 2>&1; then
  log_info "Passwordless sudo available: running Homebrew install non-interactively"
  run_homebrew_install_noninteractive

else
  log_info "Running Homebrew install interactively (may prompt for sudo)"
  run_homebrew_install
fi || {
  log_error "Homebrew installation failed"
  log_script_end "$SCRIPT_NAME"
  exit 1
}


# Add to PATH for this session (chezmoi sets up shell PATH permanently via dotfiles)
if [ -x /opt/homebrew/bin/brew ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -x /usr/local/bin/brew ]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi

log_success "Homebrew ready"
log_script_end "$SCRIPT_NAME"
