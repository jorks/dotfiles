#!/usr/bin/env sh
set -eu

# -------------------------------------------------------------------
# PURPOSE:
#   Update apt package lists and upgrade system packages
#
# SCOPE:
#   - Runs on: Linux only (excluded on macOS via .chezmoiignore)
#   - Lifecycle: run_once
#
# BEHAVIOUR:
#   - Idempotent
#   - Updates package lists
#   - Upgrades all installed packages
#   - Requires sudo
#
# NOTES:
#   - Critical early step for Debian/Ubuntu systems
#   - Ensures package manager is current before installations
# -------------------------------------------------------------------

# shellcheck source=../../_lib/log.sh
. "{{ .chezmoi.sourceDir }}/_lib/log.sh"

SCRIPT_NAME="00-base/06-linux-apt-update.sh"

{{- if ne .chezmoi.os "linux" }}
log_script_skip "$SCRIPT_NAME" "not Linux"
exit 0
{{- end }}

log_script_start "$SCRIPT_NAME"

log_info "Updating apt package lists (requires admin privileges)..."
log_warn "You may be prompted for your password"

# Update package lists
if ! sudo apt-get update; then
  log_error "Failed to update package lists"
  log_script_end "$SCRIPT_NAME"
  exit 1
fi

log_info "Upgrading installed packages..."

# Upgrade packages (non-interactive)
if sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y; then
  log_success "System packages updated"
  log_script_end "$SCRIPT_NAME"
else
  log_error "Failed to upgrade packages"
  log_script_end "$SCRIPT_NAME"
  exit 1
fi
